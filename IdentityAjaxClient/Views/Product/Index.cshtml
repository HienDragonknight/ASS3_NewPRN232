@{
    ViewData["Title"] = "Products";
}

<div class="container">
    <h1>Products</h1>

    <div class="mb-3">
        <button class="btn btn-success" id="showFormBtn">Add New Product</button>
    </div>

    <div id="productFormCard" class="card mb-4 admin-only" style="display:none;">
        <div class="card-header">
            <h2 id="formTitle">Add New Product</h2>
        </div>
        <div class="card-body">
            <form id="productForm">
                <input type="hidden" id="productId" />
                <div class="mb-3">
                    <label for="orchidName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="orchidName" required>
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">Price</label>
                    <input type="number" class="form-control" id="price" step="0.01" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="orchidUrl" class="form-label">Image URL</label>
                    <input type="text" class="form-control" id="orchidUrl" required>
                </div>
                <div class="mb-3">
                    <label for="categoryId" class="form-label">Category ID</label>
                    <input type="number" class="form-control" id="categoryId" required>
                </div>
                <div class="mb-3">
                    <label for="orchidDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="orchidDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
            </form>
        </div>
    </div>

    <div class="row" id="productList"></div>
</div>

@section Scripts {
    <script>
        let isAdmin = true;

        $(document).ready(function () {
            loadProducts();

            $(document).on('click', '#showFormBtn', function () {
                $('#productFormCard').slideDown();
            });

            $(document).on('click', '#cancelBtn', function () {
                resetForm();
                $('#productFormCard').slideUp();
            });

            $(document).on('submit', '#productForm', function (e) {
                e.preventDefault();
                saveProduct();
            });
        });

        function loadProducts() {
            $.ajax({
                url: '/api/product/GetAll',
                type: 'GET',
                success: function (products) {
                    renderProducts(products);
                },
                error: function () {
                    $('#productList').html('<div class="col-12"><div class="alert alert-danger">Error loading products</div></div>');
                }
            });
        }

        function renderProducts(products) {
            const productList = $('#productList');
            productList.empty();

            if (!products || products.length === 0) {
                productList.html('<div class="col-12"><div class="alert alert-info">No products available</div></div>');
                return;
            }

            products.forEach(function (product) {
                if (!product) return;

                const card = $('<div class="col-md-4 mb-4"></div>');
                const cardContent = `
                    <div class="card h-100">
                        <img src="${product.orchidUrl}" class="card-img-top" alt="${product.orchidName}">
                        <div class="card-body">
                            <h5 class="card-title">${product.orchidName}</h5>
                            <p class="card-text">Price: $${product.price?.toFixed(2) ?? 'N/A'}</p>
                            <p class="card-text">${product.orchidDescription ?? ''}</p>
                        </div>
                        <div class="card-footer">
                            ${isAdmin ?
                                `<button class="btn btn-sm btn-primary me-2 edit-btn" data-id="${product.orchidId}">Edit</button>
                                 <button class="btn btn-sm btn-danger" onclick="if(confirm('Are you sure you want to delete this product?')) deleteProduct(${product.orchidId})">Delete</button>` :
                                `<button class="btn btn-sm btn-info">View Details</button>`
                            }
                        </div>
                    </div>
                `;
                card.html(cardContent);
                productList.append(card);
            });

            // Wire up edit buttons
            $('.edit-btn').click(function () {
                const id = $(this).data('id');
                editProduct(id);
            });
        }

        function editProduct(id) {
            $.ajax({
                url: `/api/product/GetById/${id}`,
                type: 'GET',
                success: function (product) {
                    $('#productId').val(product.orchidId);
                    $('#orchidName').val(product.orchidName);
                    $('#price').val(product.price);
                    $('#orchidUrl').val(product.orchidUrl);
                    $('#orchidDescription').val(product.orchidDescription);
                    $('#categoryId').val(product.categoryId);
                    $('#formTitle').text('Edit Product');
                    $('#productFormCard').slideDown();
                },
                error: function () {
                    alert('Failed to load product data');
                }
            });
        }

        function saveProduct() {
            const productId = $('#productId').val();
            const product = {
                orchidName: $('#orchidName').val(),
                price: parseFloat($('#price').val()),
                orchidUrl: $('#orchidUrl').val(),
                orchidDescription: $('#orchidDescription').val(),
                categoryId: parseInt($('#categoryId').val())
            };

            const url = productId ? `/api/product/Update/${productId}` : '/api/product/Create';
            const method = productId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(product),
                success: function () {
                    resetForm();
                    $('#productFormCard').slideUp();
                    loadProducts();
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to save product';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert(errorMessage);
                }
            });
        }

        function deleteProduct(id) {
            $.ajax({
                url: `/api/product/Delete/${id}`,
                type: 'DELETE',
                success: function () {
                    loadProducts();
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to delete product';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert(errorMessage);
                }
            });
        }

        function resetForm() {
            $('#productId').val('');
            $('#productForm')[0].reset();
            $('#formTitle').text('Add New Product');
        }
    </script>
}
